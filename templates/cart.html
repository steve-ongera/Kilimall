{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="cart-container">
    <div class="cart-items">
        {% for item in cart_items %}
        <div class="cart-item" data-item-id="{{ item.id }}" >
         
            <div class="store-info">
                <i class="fas fa-store"></i>
                <span>{{ item.product.seller.store_name }} </span>
            </div>
            <div class="item-details">
                <div class="item-image">
                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                </div>
                <div class="item-info">
                    <h3 class="item-name">{{ item.product.name }}</h3>
                    {% if item.variant %}
                    <p class="item-variant">{{ item.variant }}</p>
                    {% endif %}
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-id="{{ item.id }}">âˆ’</button>
                        <input type="number" value="{{ item.quantity }}" min="1" class="quantity-input" 
                               data-id="{{ item.id }}">
                        <button class="quantity-btn plus" data-id="{{ item.id }}">+</button>
                    </div>
                </div>
                <div class="item-price">
                    <span class="price">KSh {{ item.product.price }}</span>
                    <form action="{% url 'remove_from_cart' item.id %}" method="POST" class="remove-item-form">
                        {% csrf_token %}
                        <button  type="submit" class="delete-btn" >Delete</button>
                     </form>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

    <div class="cart-summary">
        <div class="guarantee-box">
            <div class="guarantee-icon">7</div>
            <div class="guarantee-text">
                <h4>7 DAYS</h4>
                <p>Money Back Guarantee</p>
            </div>
        </div>

        <div class="cart-totals">
            <div class="total-row">
                <span>Total</span>
                <span class="total-amount">KSh {{ subtotal }}</span>
            </div>
        </div>

        <div class="cart-actions">
            <a href="{% url 'home' %}" class="continue-shopping">Continue Shopping</a>
            <button class="checkout-btn">Proceed to Check out</button>
        </div>
    </div>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
        // Handle quantity changes
        document.querySelectorAll('.item-quantity').forEach(container => {
            const decreaseBtn = container.querySelector('.decrease-qty');
            const increaseBtn = container.querySelector('.increase-qty');
            const input = container.querySelector('.quantity-input');
            const itemId = container.dataset.itemId;
    
            decreaseBtn.addEventListener('click', () => updateQuantity(itemId, 'decrease'));
            increaseBtn.addEventListener('click', () => updateQuantity(itemId, 'increase'));
        });
    
        // Handle remove buttons
        document.querySelectorAll('.remove-item-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const itemId = this.closest('.cart-item').dataset.itemId; // Ensure correct ID
                removeItem(itemId);
            });
        });
      
  
        // update quantity
    
        function updateQuantity(itemId, action) {
              fetch('{% url "update_cart_item" %}', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                      'X-CSRFToken': csrfToken
                  },
                  body: `item_id=${itemId}&action=${action}`
              })
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'success') {
                      const itemContainer = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                      const quantityInput = itemContainer.querySelector('.quantity-input');
                      const priceElement = itemContainer.querySelector('.current-price');
          
                      quantityInput.value = data.quantity;
          
                      // Update product total price
                      priceElement.textContent = `KSh ${data.item_total}`;
          
                      // Update subtotal and checkout button
                      document.querySelector('.subtotal span:last-child').textContent = `KSh ${data.cart_subtotal}`;
                      document.querySelector('.checkout-btn').textContent = `Checkout (KSh ${data.cart_subtotal})`;
                  }
              })
              .catch(error => console.error('Error:', error));
          }
          
    
        function removeItem(itemId) {
          if (!itemId) return;
  
          fetch(`/cart/remove/${itemId}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest'
              },
              credentials: 'same-origin'
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  // Remove item from DOM
                  const itemContainer = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                  if (itemContainer) {
                      itemContainer.remove();
  
                      // Update subtotal displays
                      const subtotalElements = document.querySelectorAll('.cart-subtotal');
                      subtotalElements.forEach(el => {
                          el.textContent = `KSh ${data.cart_subtotal}`;
                      });
  
                      const checkoutBtn = document.querySelector('.checkout-btn');
                      if (checkoutBtn) {
                          checkoutBtn.textContent = `Checkout (KSh ${data.cart_subtotal})`;
                      }
  
                      // Update cart count in header
                      const cartCount = document.querySelector('.cart-count');
                      if (cartCount) {
                          cartCount.textContent = data.cart_count;
                      }
  
                      // Update cart header count
                      const cartHeader = document.querySelector('.cart-header h1');
                      if (cartHeader) {
                          const currentCount = document.querySelectorAll('.cart-item').length;
                          cartHeader.textContent = `Cart (${currentCount})`;
                      }
                  }
              }
          })
          .catch(error => console.error('Error:', error));
      }
    });
    </script>
  
  
{% endblock %}

